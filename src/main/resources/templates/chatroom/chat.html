<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/header-n-side}">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>채팅방</title>

    <link rel="stylesheet" th:href="@{/css/chat.css}">
    <script src="https://cdn.jsdelivr.net/sockjs/1.0.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <main layout:fragment="main" class="mt-20">
        <header>
            <h1 class="chat-room-name" th:text="${chatRoomName}">채팅방 이름</h1>
            <p>(<span class="members-num" th:text="${memberCount}">인원수</span>)</p>
        </header>
        <div class="chat-box">
<!--            <div class="sent-message">-->
<!--                <p class="member-name">작성자</p>-->
<!--                <div class="content">여기에 그래도 내용이</div>-->
<!--                <p class="sent-time">12:00</p>-->
<!--            </div>-->
<!--            <div class="other-message">-->
<!--                <p class="member-name">작성자</p>-->
<!--                <div class="content">여기에 그래도 내용이</div>-->
<!--                <p class="sent-time">12:00</p>-->
<!--            </div>-->
            <div th:each="message : ${messages}" class="message" th:classappend="${message.senderId == #authentication.principal.userId} ? 'sent-message' : 'other-message'">
                <p class="member-name" th:text="${message.senderNickname}">닉네임</p>
                <div class="content" th:text="${message.content}">메시지 내용</div>
                <p class="sent-time" th:text="${#dates.format(message.sentTime, 'HH:mm:ss')}">시간</p>
            </div>
        </div>
        <div class="chat-input">
            <form action="#" onsubmit="sendMessage(); return false;">
                <input id="message-input" type="text" placeholder="보낼 내용을 입력해주세요.">
                <button type="submit">보내기</button>
            </form>
        </div>
    </main>

    <script>
        let stompClient = null;
        let subscription = null;
        let currentRoomId = null;
        let memberId = '현재 사용자 ID'; // 서버에서 사용자 ID를 가져오는 방법에 따라 설정

        window.onload = () => {
            connect();
        };

        function connect() {
            const socket = new SockJS('/chat');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
            });
        }

        function enterRoom(roomId) {
            if (subscription) {
                subscription.unsubscribe();
            }
            currentRoomId = roomId;
            document.getElementById("currentRoomNumber").innerText = currentRoomId;
            subscription = stompClient.subscribe(`/sub/chats/rooms/${roomId}`, function (message) {
                showMessage(JSON.parse(message.body));
            });
        }

        function sendMessageWithEnter(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (e.isComposing) {
                    return;
                }
                sendMessage();
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById("message-input");
            const message = messageInput.value.trim();

            if (message === '') return;

            const name = document.getElementById("name").value;
            const sender = document.getElementById("memberId").value || memberId;

            stompClient.send(`/pub/chats/rooms/${currentRoomId}`, {}, JSON.stringify({
                memberId: sender,
                name: name,
                roomId: currentRoomId,
                message: message
            }));

            messageInput.value = "";
        }

        function showMessage(message) {
            const response = document.getElementById('messages');
            const textBox = document.createElement('div');
            const messageSpan = document.createElement("span");
            const nameSpan = document.createElement("span");

            textBox.appendChild(nameSpan);
            textBox.appendChild(messageSpan);

            textBox.classList.add("chat-box");

            if (message.memberId === memberId) {
                textBox.style.textAlign = "right";
                messageSpan.classList.add("chat-right");
            } else {
                messageSpan.classList.add("chat-left");
            }

            messageSpan.classList.add("chat-message");

            messageSpan.innerText = `${message.message}`;
            nameSpan.innerText = message.name;
            response.appendChild(textBox);

            setTimeout(() => {
                response.scrollTop = response.scrollHeight;
            }, 50);
        }

        function unsubscribe() {
            if (subscription) {
                subscription.unsubscribe();
                subscription = null;
            }
        }
    </script>
</body>
</html>