<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>

  <style>
      body {
          margin: 0;
          font-family: Arial, sans-serif;
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          background-color: #f0f0f0;
      }
      .chat-wrapper {
          width: 100%;
          max-width: 800px;
          display: flex;
          flex-direction: column;
          height: 90vh;
          background: #fff;
          border-radius: 8px;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .chat-header {
          background: #fff;
          border-bottom: 1px solid #e7eaec;
          padding: 15px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .chat-body {
          flex: 1;
          background: #ffffff;
          padding: 15px;
          overflow-y: auto;
      }
      .chat-footer {
          background: #fff;
          border-top: 1px solid #e7eaec;
          padding: 15px;
          display: flex;
          align-items: center;
      }
      .chat-box {
          display: flex;
          flex-direction: column;
          padding: 5px;
          margin-top: 10px;
      }
      .chat-message{
          color: white;
          width: auto;
          height: auto;
          padding: 5px;
      }
      .chat-right {
          text-align: right;
          background: #66CDAA;
          margin-left: auto;
      }
      .chat-left {
          background: #D9D9D9;
          margin-right: auto;
      }
      .message-author {
          font-weight: bold;
      }
      .message-date {
          font-size: 0.8em;
          color: #888;
      }
      .message-content {
          margin-top: 5px;
      }
      .form-control {
          width: 100%;
          height: 50px; /* 고정된 높이 */
          padding: 10px;
          border: 1px solid #e5e6e7;
          border-radius: 4px;
          box-sizing: border-box; /* 패딩과 경계를 포함한 너비 및 높이 조정 */
          resize: none; /* 크기 조정 비활성화 */
      }
      .chat-footer input {
          margin-right: 10px;
      }
  </style>
</head>
<body>
<div style="display: flex;">
<!--  <section style="width: 30%;">-->
<!--    <ul>-->
<!--      &lt;!&ndash; 채팅방 목록 버튼 &ndash;&gt;-->
<!--      <li><button onclick="enterRoom(1)">1</button></li>-->
<!--      <li><button onclick="enterRoom(2)">2</button></li>-->
<!--      <li><button onclick="enterRoom(3)">3</button></li>-->
<!--    </ul>-->
<!--    <div>-->
<!--      <p>현재 접속중인 방은 <span id="currentRoomNumber"></span></p>-->
<!--    </div>-->
<!--  </section>-->
    <div class="chat-wrapper">
        <header class="chat-header">
            <strong id="chat-room-name">채팅방 이름</strong>
        </header>
        <main class="chat-body" id="chat-discussion">
            <!-- 메시지가 여기에 추가됩니다. -->
        </main>
        <footer class="chat-footer">
            <textarea id="message-input" class="form-control" placeholder="메시지를 입력하세요." onkeydown="sendMessageWithEnter(event)"></textarea>
            <button type="button" id="send" onclick="sendMessage()">전송</button>
        </footer>
    </div>
</div>
</body>

<script src="https://cdn.jsdelivr.net/sockjs/1.0.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>


<script>
  let stompClient = null;
  let currentRoomId = null;
  let memberId = 1;
  let subscription = null; //현재 구독하고 있는 topic

  window.onload = () => {
    connect();
  }

  //websocket 연결
  function connect() {
    const socket = new SockJS('/chat');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
      console.log('Connected: ' + frame);
    });
  }


  function enterRoom(roomId) {
    if (subscription) {
      subscription.unsubscribe();
    }
    currentRoomId = roomId;
    // unsubscribe
    // 방들어갔을때 메시지는 얼마나 보여줄것인가?
    // 채팅방 들어갔을 때 메시지 보여주는 거.
    //Kakao 생각하시면 된다. 그 중간에 데이터를 어떻게 할 것인가. 싱크를 생각해야해요
    document.getElementById("currentRoomNumber").innerText = currentRoomId;
    subscription = stompClient.subscribe(`/sub/chat/room/${roomId}`, function (message) {
      console.log("subscribe", {message})
      showMessage(JSON.parse(message.body));
    });
  }

  function sendMessageWithEnter(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (e.isComposing) {
        return;
      }
      sendMessage();
    }
  }

  function sendMessage() {
    const message = document.getElementById("message");
    const messageInput = message.value;

    // 공백을 보낼 때 trim()없이 비교하면 된다.
    if (messageInput.trim() === '') return;

    const name = document.getElementById("name").value;
    const sender = document.getElementById("entityId").value || entityId;

    console.log({name}, {currentRoomId}, {message})
    stompClient.send(`/pub/chat/room/${currentRoomId}`, {}, JSON.stringify({
      entityId: sender,
      name: name,
      roomId: currentRoomId,
      message: messageInput
      // 메시지를 매번 저장해야할 때 데이터가 추가로 필요하다.
    }));

    message.value = "";
  }

  function showMessage(message) {
    console.log("showMessage", {message});
    const response = document.getElementById('messages');
    const textBox = document.createElement('div');
    const messageSpan = document.createElement("span");
    const nameSpan = document.createElement("span");

    textBox.appendChild(nameSpan);
    textBox.appendChild(messageSpan);

    textBox.classList.add("chat-box");

    if (message.entityId === entityId) {
      textBox.style.textAlign = "right";
      messageSpan.classList.add("chat-right")
    } else {
      messageSpan.classList.add("chat-left")
    }

    textBox.innerHTML = `
        <span class="message-author">${message.name}</span>
        <span class="message-date">${new Date().toLocaleString()}</span>
        <div class="message-content">${message.message}</div>
    `;

    messageSpan.classList.add("chat-message")

    messageSpan.innerText = `${message.message}`;

    response.appendChild(textBox);

    setTimeout(() => {
      response.scrollTop = response.scrollHeight; // 최신 메시지가 자동으로 스크롤됨
    }, 50);


  }

  //unsubscribe
  function unsubscribe() {
    if (subscription) {
      subscription.unsubscribe();
      subscription = null;
    }
  }
</script>

</html>